'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
    value: true
});

var _punycode = require('punycode');

var _punycode2 = _interopRequireDefault(_punycode);

var JID = (function () {
    function JID(a, b, c) {
        var _this = this;

        _classCallCheck(this, JID);

        this._local = '';
        this._domain = '';
        this.resource = '';

        this.toString = function (unescape) {
            return unescape ? _this.unescapedFull : _this.full;
        };

        this.toJSON = function () {
            return _this.full;
        };

        if (a && !b && !c) {
            if (typeof a === 'string') {
                this.parseJID(a);
            } else if (a instanceof JID || a.hasOwnProperty('_local') && a.hasOwnProperty('_domain') && a.hasOwnProperty('resource')) {
                _Object$assign(this, a);
            } else {
                throw new Error('Argument error');
            }
        } else if (b) {
            this.local = a;
            this.domain = b;
            this.resource = c;
        }
    }

    _createClass(JID, [{
        key: 'parseJID',
        value: function parseJID(s) {
            if (s.includes('/')) {
                this.resource = s.substr(s.indexOf('/') + 1);
                s = s.substr(0, s.indexOf('/'));
            }

            if (s.includes('@')) {
                this.local = s.substr(0, s.lastIndexOf('@'));
                s = s.substr(s.lastIndexOf('@') + 1);
            }

            this.domain = s;
        }
    }, {
        key: 'equals',
        value: function equals(other) {
            return this.local === other.local && this.domain === other.domain && this.resource === other.resource;
        }
    }, {
        key: 'detectEscape',
        value: function detectEscape(local) {
            if (!local) {
                return false;
            }

            var tmp = local.replace(/\\20/g, '').replace(/\\22/g, '').replace(/\\26/g, '').replace(/\\27/g, '').replace(/\\2f/g, '').replace(/\\3a/g, '').replace(/\\3c/g, '').replace(/\\3e/g, '').replace(/\\40/g, '').replace(/\\5c/g, '');

            var search = tmp.search(/\\| |\"|\&|\'|\/|:|<|>|@/g);

            if (search === -1) {
                return false;
            } else {
                return true;
            }
        }
    }, {
        key: 'escapeLocal',
        value: function escapeLocal(local) {
            if (local === null) {
                return null;
            }

            return local.replace(/^\s+|\s+$/g, '').replace(/\\5c/g, '\\5c5c').replace(/\\20/g, '\\5c20').replace(/\\22/g, '\\5c22').replace(/\\26/g, '\\5c26').replace(/\\27/g, '\\5c27').replace(/\\2f/g, '\\5c2f').replace(/\\3a/g, '\\5c3a').replace(/\\3c/g, '\\5c3c').replace(/\\3e/g, '\\5c3e').replace(/\\40/g, '\\5c40').replace(/ /g, '\\20').replace(/\"/g, '\\22').replace(/\&/g, '\\26').replace(/\'/g, '\\27').replace(/\//g, '\\2f').replace(/:/g, '\\3a').replace(/</g, '\\3c').replace(/>/g, '\\3e').replace(/@/g, '\\40');
        }
    }, {
        key: 'unescapeLocal',
        value: function unescapeLocal(local) {
            if (local === null) {
                return null;
            }

            return local.replace(/\\20/g, ' ').replace(/\\22/g, '"').replace(/\\26/g, '&').replace(/\\27/g, '\'').replace(/\\2f/g, '/').replace(/\\3a/g, ':').replace(/\\3c/g, '<').replace(/\\3e/g, '>').replace(/\\40/g, '@').replace(/\\5c/g, '\\');
        }
    }, {
        key: 'unescapedFull',
        get: function get() {
            var s = this.domain;

            if (this.local) {
                s = this.unescapedLocal + '@' + s;
            }
            if (this.resource) {
                s = s + '/' + this.resource;
            }

            return s;
        }
    }, {
        key: 'full',
        get: function get() {
            var s = this.domain;

            if (this.local) {
                s = this.local + '@' + s;
            }
            if (this.resource) {
                s = s + '/' + this.resource;
            }

            return s;
        }
    }, {
        key: 'bare',
        get: function get() {
            if (this.resource) {
                return new JID(this.local, this.domain).full;
            } else {
                return this.full;
            }
        }
    }, {
        key: 'unescapedBare',
        get: function get() {
            if (this.resource) {
                return new JID(this.local, this.domain).unescapedFull;
            } else {
                return this.unescapedFull;
            }
        }
    }, {
        key: 'unescapedLocal',
        get: function get() {
            return this.unescapeLocal(this._local);
        }
    }, {
        key: 'local',
        get: function get() {
            return this._local;
        },
        set: function set(local) {
            var escape = this.detectEscape(local);

            if (escape) {
                local = this.escapeLocal(local);
            }

            this._local = local && local.toLowerCase();
            this.user = this._local;
        }
    }, {
        key: 'domain',
        get: function get() {
            return this._domain;
        },
        set: function set(domain) {
            this._domain = _punycode2['default'].toUnicode(domain).toLowerCase();
        }
    }], [{
        key: 'equal',
        value: function equal(jid1, jid2, bare) {
            jid1 = new JID(jid1);
            jid2 = new JID(jid2);

            if (bare) {
                return jid1.local === jid2.local && jid1.domain === jid2.domain;
            }

            return jid1.local === jid2.local && jid1.domain === jid2.domain && jid1.resource === jid2.resource;
        }
    }, {
        key: 'equalBare',
        value: function equalBare(jid1, jid2) {
            return JID.equal(jid1, jid2, true);
        }
    }, {
        key: 'create',
        value: function create(local, domain, resource) {
            return new JID(local, domain, resource);
        }
    }, {
        key: 'isBare',
        value: function isBare(jid) {
            jid = new JID(jid);

            var hasResource = !!jid.resource;

            return !hasResource;
        }
    }, {
        key: 'isFull',
        value: function isFull(jid) {
            jid = new JID(jid);

            var hasResource = !!jid.resource;

            return hasResource;
        }
    }]);

    return JID;
})();

exports['default'] = JID;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,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QUksQ0FBQyxDQUFDO1NBQ3RDOzs7ZUFFWSxnQkFBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRTtBQUNuQyxtQkFBTyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1NBQzNDOzs7ZUFFWSxnQkFBQyxHQUFHLEVBQUU7QUFDZixlQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7O0FBRW5CLGdCQUFNLFdBQVcsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQzs7QUFFbkMsbUJBQU8sQ0FBQyxXQUFXLENBQUM7U0FDdkI7OztlQUVZLGdCQUFDLEdBQUcsRUFBRTtBQUNmLGVBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQzs7QUFFbkIsZ0JBQU0sV0FBVyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDOztBQUVuQyxtQkFBTyxXQUFXLENBQUM7U0FDdEI7OztXQS9PQyxHQUFHOzs7cUJBa1BNLEdBQUciLCJmaWxlIjoiSklELmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHB1bnljb2RlIGZyb20gJ3B1bnljb2RlJztcblxuLyoqXG4gKiBKSUQgaW1wbGVtZW50c1xuICogLSBYbXBwIGFkZHJlc3NlcyBhY2NvcmRpbmcgdG8gUkZDNjEyMlxuICogLSBYRVAtMDEwNjogSklEIEVzY2FwaW5nXG4gKlxuICogQHNlZSBodHRwOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmM2MTIyI3NlY3Rpb24tMlxuICogQHNlZSBodHRwOi8veG1wcC5vcmcvZXh0ZW5zaW9ucy94ZXAtMDEwNi5odG1sXG4gKi9cbmNsYXNzIEpJRCB7XG4gICAgX2xvY2FsID0gJyc7XG4gICAgX2RvbWFpbiA9ICcnO1xuICAgIHJlc291cmNlID0gJyc7XG5cbiAgICBjb25zdHJ1Y3RvcihhLCBiLCBjKSB7XG4gICAgICAgIGlmIChhICYmICFiICYmICFjKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGEgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wYXJzZUpJRChhKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgICAgICAgICAgYSBpbnN0YW5jZW9mIEpJRCB8fFxuICAgICAgICAgICAgICAgIGEuaGFzT3duUHJvcGVydHkoJ19sb2NhbCcpICYmIGEuaGFzT3duUHJvcGVydHkoJ19kb21haW4nKSAmJiBhLmhhc093blByb3BlcnR5KCdyZXNvdXJjZScpXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMsIGEpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FyZ3VtZW50IGVycm9yJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoYikge1xuICAgICAgICAgICAgdGhpcy5sb2NhbCA9IGE7XG4gICAgICAgICAgICB0aGlzLmRvbWFpbiA9IGI7XG4gICAgICAgICAgICB0aGlzLnJlc291cmNlID0gYztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHBhcnNlSklEKHMpIHtcbiAgICAgICAgaWYgKHMuaW5jbHVkZXMoJy8nKSkge1xuICAgICAgICAgICAgdGhpcy5yZXNvdXJjZSA9IHMuc3Vic3RyKHMuaW5kZXhPZignLycpICsgMSk7XG4gICAgICAgICAgICBzID0gcy5zdWJzdHIoMCwgcy5pbmRleE9mKCcvJykpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHMuaW5jbHVkZXMoJ0AnKSkge1xuICAgICAgICAgICAgdGhpcy5sb2NhbCA9IHMuc3Vic3RyKDAsIHMubGFzdEluZGV4T2YoJ0AnKSk7XG4gICAgICAgICAgICBzID0gcy5zdWJzdHIocy5sYXN0SW5kZXhPZignQCcpICsgMSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmRvbWFpbiA9IHM7XG4gICAgfVxuXG4gICAgZ2V0IHVuZXNjYXBlZEZ1bGwoKSB7XG4gICAgICAgIGxldCBzID0gdGhpcy5kb21haW47XG5cbiAgICAgICAgaWYgKHRoaXMubG9jYWwpIHtcbiAgICAgICAgICAgIHMgPSBgJHt0aGlzLnVuZXNjYXBlZExvY2FsfUAke3N9YDtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5yZXNvdXJjZSkge1xuICAgICAgICAgICAgcyA9IGAke3N9LyR7dGhpcy5yZXNvdXJjZX1gO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHM7XG4gICAgfVxuXG4gICAgZ2V0IGZ1bGwoKSB7XG4gICAgICAgIGxldCBzID0gdGhpcy5kb21haW47XG5cbiAgICAgICAgaWYgKHRoaXMubG9jYWwpIHtcbiAgICAgICAgICAgIHMgPSBgJHt0aGlzLmxvY2FsfUAke3N9YDtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5yZXNvdXJjZSkge1xuICAgICAgICAgICAgcyA9IGAke3N9LyR7dGhpcy5yZXNvdXJjZX1gO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHM7XG4gICAgfVxuXG4gICAgdG9TdHJpbmcgPSAodW5lc2NhcGUpID0+IHVuZXNjYXBlID8gdGhpcy51bmVzY2FwZWRGdWxsIDogdGhpcy5mdWxsO1xuICAgIHRvSlNPTiA9ICgpID0+IHRoaXMuZnVsbDtcblxuICAgIC8qKlxuICAgICAqIENvbnZlbmllbmNlIG1ldGhvZCB0byBkaXN0aW5ndWlzaCB1c2Vyc1xuICAgICAqKi9cbiAgICBnZXQgYmFyZSgpIHtcbiAgICAgICAgaWYgKHRoaXMucmVzb3VyY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgSklEKHRoaXMubG9jYWwsIHRoaXMuZG9tYWluKS5mdWxsO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZnVsbDtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvKipcbiAgICAgKiBDb252ZW5pZW5jZSBtZXRob2QgdG8gZGlzdGluZ3Vpc2ggdXNlcnNcbiAgICAgKiovXG4gICAgZ2V0IHVuZXNjYXBlZEJhcmUoKSB7XG4gICAgICAgIGlmICh0aGlzLnJlc291cmNlKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IEpJRCh0aGlzLmxvY2FsLCB0aGlzLmRvbWFpbikudW5lc2NhcGVkRnVsbDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnVuZXNjYXBlZEZ1bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBlcXVhbHMob3RoZXIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9jYWwgPT09IG90aGVyLmxvY2FsICYmXG4gICAgICAgICAgICB0aGlzLmRvbWFpbiA9PT0gb3RoZXIuZG9tYWluICYmXG4gICAgICAgICAgICB0aGlzLnJlc291cmNlID09PSBvdGhlci5yZXNvdXJjZTtcbiAgICB9XG5cbiAgICBnZXQgdW5lc2NhcGVkTG9jYWwoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnVuZXNjYXBlTG9jYWwodGhpcy5fbG9jYWwpO1xuICAgIH1cbiAgICBnZXQgbG9jYWwoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9sb2NhbDtcbiAgICB9XG4gICAgc2V0IGxvY2FsKGxvY2FsKSB7XG4gICAgICAgIGNvbnN0IGVzY2FwZSA9IHRoaXMuZGV0ZWN0RXNjYXBlKGxvY2FsKTtcblxuICAgICAgICBpZiAoZXNjYXBlKSB7XG4gICAgICAgICAgICBsb2NhbCA9IHRoaXMuZXNjYXBlTG9jYWwobG9jYWwpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fbG9jYWwgPSBsb2NhbCAmJiBsb2NhbC50b0xvd2VyQ2FzZSgpO1xuICAgICAgICB0aGlzLnVzZXIgPSB0aGlzLl9sb2NhbDtcbiAgICB9XG5cbiAgICBnZXQgZG9tYWluKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZG9tYWluO1xuICAgIH1cbiAgICBzZXQgZG9tYWluKGRvbWFpbikge1xuICAgICAgICB0aGlzLl9kb21haW4gPSBwdW55Y29kZS50b1VuaWNvZGUoZG9tYWluKS50b0xvd2VyQ2FzZSgpO1xuICAgIH1cblxuICAgIGRldGVjdEVzY2FwZShsb2NhbCkge1xuICAgICAgICBpZiAoIWxvY2FsKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICAvLyByZW1vdmUgYWxsIGVzY2FwZWQgc2VxdWVuY2VzXG4gICAgICAgIGNvbnN0IHRtcCA9IGxvY2FsLnJlcGxhY2UoL1xcXFwyMC9nLCAnJylcbiAgICAgICAgICAgIC5yZXBsYWNlKC9cXFxcMjIvZywgJycpXG4gICAgICAgICAgICAucmVwbGFjZSgvXFxcXDI2L2csICcnKVxuICAgICAgICAgICAgLnJlcGxhY2UoL1xcXFwyNy9nLCAnJylcbiAgICAgICAgICAgIC5yZXBsYWNlKC9cXFxcMmYvZywgJycpXG4gICAgICAgICAgICAucmVwbGFjZSgvXFxcXDNhL2csICcnKVxuICAgICAgICAgICAgLnJlcGxhY2UoL1xcXFwzYy9nLCAnJylcbiAgICAgICAgICAgIC5yZXBsYWNlKC9cXFxcM2UvZywgJycpXG4gICAgICAgICAgICAucmVwbGFjZSgvXFxcXDQwL2csICcnKVxuICAgICAgICAgICAgLnJlcGxhY2UoL1xcXFw1Yy9nLCAnJyk7XG5cbiAgICAgICAgLy8gZGV0ZWN0IGlmIHdlIGhhdmUgdW5lc2NhcGVkIHNlcXVlbmNlc1xuICAgICAgICBjb25zdCBzZWFyY2ggPSB0bXAuc2VhcmNoKC9cXFxcfCB8XFxcInxcXCZ8XFwnfFxcL3w6fDx8PnxAL2cpO1xuXG4gICAgICAgIGlmIChzZWFyY2ggPT09IC0xKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEVzY2FwZSB0aGUgbG9jYWwgcGFydCBvZiBhIEpJRC5cbiAgICAgKlxuICAgICAqIEBzZWUgaHR0cDovL3htcHAub3JnL2V4dGVuc2lvbnMveGVwLTAxMDYuaHRtbFxuICAgICAqIEBwYXJhbSBTdHJpbmcgbG9jYWwgbG9jYWwgcGFydCBvZiBhIGppZFxuICAgICAqIEByZXR1cm4gQW4gZXNjYXBlZCBsb2NhbCBwYXJ0XG4gICAgICovXG4gICAgZXNjYXBlTG9jYWwobG9jYWwpIHtcbiAgICAgICAgaWYgKGxvY2FsID09PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBsb2NhbC5yZXBsYWNlKC9eXFxzK3xcXHMrJC9nLCAnJylcbiAgICAgICAgICAucmVwbGFjZSgvXFxcXDVjL2csICdcXFxcNWM1YycpXG4gICAgICAgICAgLnJlcGxhY2UoL1xcXFwyMC9nLCAnXFxcXDVjMjAnKVxuICAgICAgICAgIC5yZXBsYWNlKC9cXFxcMjIvZywgJ1xcXFw1YzIyJylcbiAgICAgICAgICAucmVwbGFjZSgvXFxcXDI2L2csICdcXFxcNWMyNicpXG4gICAgICAgICAgLnJlcGxhY2UoL1xcXFwyNy9nLCAnXFxcXDVjMjcnKVxuICAgICAgICAgIC5yZXBsYWNlKC9cXFxcMmYvZywgJ1xcXFw1YzJmJylcbiAgICAgICAgICAucmVwbGFjZSgvXFxcXDNhL2csICdcXFxcNWMzYScpXG4gICAgICAgICAgLnJlcGxhY2UoL1xcXFwzYy9nLCAnXFxcXDVjM2MnKVxuICAgICAgICAgIC5yZXBsYWNlKC9cXFxcM2UvZywgJ1xcXFw1YzNlJylcbiAgICAgICAgICAucmVwbGFjZSgvXFxcXDQwL2csICdcXFxcNWM0MCcpXG4gICAgICAgICAgLnJlcGxhY2UoLyAvZywgJ1xcXFwyMCcpXG4gICAgICAgICAgLnJlcGxhY2UoL1xcXCIvZywgJ1xcXFwyMicpXG4gICAgICAgICAgLnJlcGxhY2UoL1xcJi9nLCAnXFxcXDI2JylcbiAgICAgICAgICAucmVwbGFjZSgvXFwnL2csICdcXFxcMjcnKVxuICAgICAgICAgIC5yZXBsYWNlKC9cXC8vZywgJ1xcXFwyZicpXG4gICAgICAgICAgLnJlcGxhY2UoLzovZywgJ1xcXFwzYScpXG4gICAgICAgICAgLnJlcGxhY2UoLzwvZywgJ1xcXFwzYycpXG4gICAgICAgICAgLnJlcGxhY2UoLz4vZywgJ1xcXFwzZScpXG4gICAgICAgICAgLnJlcGxhY2UoL0AvZywgJ1xcXFw0MCcpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVuZXNjYXBlIGEgbG9jYWwgcGFydCBvZiBhIEpJRC5cbiAgICAgKlxuICAgICAqIEBzZWUgaHR0cDovL3htcHAub3JnL2V4dGVuc2lvbnMveGVwLTAxMDYuaHRtbFxuICAgICAqIEBwYXJhbSBTdHJpbmcgbG9jYWwgbG9jYWwgcGFydCBvZiBhIGppZFxuICAgICAqIEByZXR1cm4gdW5lc2NhcGVkIGxvY2FsIHBhcnRcbiAgICAgKi9cbiAgICB1bmVzY2FwZUxvY2FsKGxvY2FsKSB7XG4gICAgICAgIGlmIChsb2NhbCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbG9jYWwucmVwbGFjZSgvXFxcXDIwL2csICcgJylcbiAgICAgICAgICAgIC5yZXBsYWNlKC9cXFxcMjIvZywgJ1wiJylcbiAgICAgICAgICAgIC5yZXBsYWNlKC9cXFxcMjYvZywgJyYnKVxuICAgICAgICAgICAgLnJlcGxhY2UoL1xcXFwyNy9nLCAnXFwnJylcbiAgICAgICAgICAgIC5yZXBsYWNlKC9cXFxcMmYvZywgJy8nKVxuICAgICAgICAgICAgLnJlcGxhY2UoL1xcXFwzYS9nLCAnOicpXG4gICAgICAgICAgICAucmVwbGFjZSgvXFxcXDNjL2csICc8JylcbiAgICAgICAgICAgIC5yZXBsYWNlKC9cXFxcM2UvZywgJz4nKVxuICAgICAgICAgICAgLnJlcGxhY2UoL1xcXFw0MC9nLCAnQCcpXG4gICAgICAgICAgICAucmVwbGFjZSgvXFxcXDVjL2csICdcXFxcJyk7XG4gICAgfVxuXG4gICAgc3RhdGljIGVxdWFsKGppZDEsIGppZDIsIGJhcmUpIHtcbiAgICAgICAgamlkMSA9IG5ldyBKSUQoamlkMSk7XG4gICAgICAgIGppZDIgPSBuZXcgSklEKGppZDIpO1xuXG4gICAgICAgIGlmIChiYXJlKSB7XG4gICAgICAgICAgICByZXR1cm4gamlkMS5sb2NhbCA9PT0gamlkMi5sb2NhbCAmJlxuICAgICAgICAgICAgICAgIGppZDEuZG9tYWluID09PSBqaWQyLmRvbWFpbjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBqaWQxLmxvY2FsID09PSBqaWQyLmxvY2FsICYmXG4gICAgICAgICAgICBqaWQxLmRvbWFpbiA9PT0gamlkMi5kb21haW4gJiZcbiAgICAgICAgICAgIGppZDEucmVzb3VyY2UgPT09IGppZDIucmVzb3VyY2U7XG4gICAgfVxuXG4gICAgc3RhdGljIGVxdWFsQmFyZShqaWQxLCBqaWQyKSB7XG4gICAgICAgIHJldHVybiBKSUQuZXF1YWwoamlkMSwgamlkMiwgdHJ1ZSk7XG4gICAgfVxuXG4gICAgc3RhdGljIGNyZWF0ZShsb2NhbCwgZG9tYWluLCByZXNvdXJjZSkge1xuICAgICAgICByZXR1cm4gbmV3IEpJRChsb2NhbCwgZG9tYWluLCByZXNvdXJjZSk7XG4gICAgfVxuXG4gICAgc3RhdGljIGlzQmFyZShqaWQpIHtcbiAgICAgICAgamlkID0gbmV3IEpJRChqaWQpO1xuXG4gICAgICAgIGNvbnN0IGhhc1Jlc291cmNlID0gISFqaWQucmVzb3VyY2U7XG5cbiAgICAgICAgcmV0dXJuICFoYXNSZXNvdXJjZTtcbiAgICB9XG5cbiAgICBzdGF0aWMgaXNGdWxsKGppZCkge1xuICAgICAgICBqaWQgPSBuZXcgSklEKGppZCk7XG5cbiAgICAgICAgY29uc3QgaGFzUmVzb3VyY2UgPSAhIWppZC5yZXNvdXJjZTtcblxuICAgICAgICByZXR1cm4gaGFzUmVzb3VyY2U7XG4gICAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBKSUQ7XG4iXX0=